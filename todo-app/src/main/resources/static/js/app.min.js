import Alpine from"https://esm.sh/alpinejs@3.12.0";import{Store}from"./modules/store.js";import{Api}from"./modules/api.js";import{Drag}from"./modules/drag.js";console.log("[App] ====== Application Loading ======"),console.log("[App] Alpine.js ESM Module System"),console.log("[App] Modules imported: Store, Api, Drag"),Alpine.data("todoApp",()=>({lanes:[],tasks:[],showSaved:!1,columns:["TODO","IN_PROGRESS","DONE","BLOCKED","DEFERRED"],hideDone:!1,showOnlyBlocked:!1,selectedTags:[],isLoading:!0,mobileSidebarOpen:!1,activeLaneId:null,isMobile:!1,...Store,async init(){console.log("[App] ====== Component Initializing ======"),document.addEventListener("click",e=>{e.target.closest(".task-card")&&console.log("[App] Task Card clicked:",{taskId:e.target.closest(".task-card").getAttribute("data-task-id"),target:e.target.tagName})},!0);try{const e=document.getElementById("initial-data");if(console.log("[App] DEBUG: Looking for #initial-data script tag..."),console.log("[App] DEBUG: dataScript element:",e),e){console.log("[App] Step 1: Found server-side initial data, parsing...");const t=e.textContent;console.log("[App] DEBUG: Raw JSON length:",t?t.length:0),console.log("[App] DEBUG: First 200 chars:",t?t.substring(0,200):"null");try{const e=JSON.parse(t);console.log("[App] DEBUG: JSON parsed successfully"),this.lanes=e.lanes||[],this.tasks=e.tasks||[],console.log(`[App] Loaded ${this.lanes.length} lanes and ${this.tasks.length} tasks from initial data`),this.lanes.forEach(e=>{const t=this.tasks.filter(t=>t.swimLane&&t.swimLane.id===e.id);e.loading=!1,e.collapsed=0===t.length}),this.$nextTick(()=>{this.lanes.forEach(e=>{this.reinitSortableForLane(e.id)})}),this.isLoading=!1}catch(e){console.error("[App] DEBUG: JSON parse failed:",e),console.log("[App] Falling back to API fetch due to parse error..."),await this.loadViaApi()}}else console.log("[App] Step 1: No initial data script found, falling back to API fetch..."),await this.loadViaApi()}catch(e){console.error("[App] Failed to initialize:",e)}this.$nextTick(()=>{console.log("[App] Step 3: Setting up lane-level drag..."),this.setupDrag()}),console.log("[App] Step 4: Initializing SSE connection..."),Api.initSSE(e=>this.onServerTaskUpdate(e),e=>this.onServerTaskDelete(e),e=>console.log("[App] SSE Lane update received:",e)),console.log("[App] ====== Initialization Complete ======"),this.checkMobile(),window.addEventListener("resize",()=>this.checkMobile()),this.lanes.length>0&&!this.activeLaneId&&(this.activeLaneId=this.lanes[0].id)},checkMobile(){const e=this.isMobile;this.isMobile=window.innerWidth<992,e&&!this.isMobile&&(this.mobileSidebarOpen=!1),console.log("[App] checkMobile:",{isMobile:this.isMobile,width:window.innerWidth})},toggleMobileSidebar(){this.mobileSidebarOpen=!this.mobileSidebarOpen,console.log("[App] toggleMobileSidebar:",this.mobileSidebarOpen)},selectLane(e){console.log("[App] selectLane:",e),this.activeLaneId=e,this.mobileSidebarOpen=!1,window.scrollTo({top:0,behavior:"smooth"})},isLaneVisible(e){return this.isMobile?e===this.activeLaneId&&this.laneHasMatchingTasks(e):this.laneHasMatchingTasks(e)},getLaneName(e){const t=this.lanes.find(t=>t.id===e);return t?t.name:""},async loadViaApi(){console.log("[App] loadViaApi: Starting async API fetch...");const e=await Store.loadData();this.lanes=e.lanes,console.log(`[App] Loaded ${this.lanes.length} lanes via API`);const t=this.lanes.map(async e=>{try{const t=await Store.fetchLaneTasks(e.id);this.tasks.push(...t);const s=this.lanes.find(t=>t.id===e.id);s&&(s.loading=!1,s.collapsed=0===t.length),this.$nextTick(()=>{this.reinitSortableForLane(e.id)})}catch(t){console.error(`[App] Error fetching tasks for lane ${e.id}:`,t)}});await Promise.all(t),console.log("[App] All lanes loaded via API"),this.isLoading=!1},setupDrag(){console.log("[App] setupDrag: Initializing board-level drag (swimlanes)");const e=document.querySelector(".board-container");e?Drag.initLaneSortable(e,this,()=>{console.log("[App] Lane reorder complete, callback fired")}):console.error("[App] ERROR: .board-container not found!")},setupTaskSortables(){console.warn("[App] setupTaskSortables called - this may init empty columns!");const e=document.querySelectorAll(".lane-column");console.log(`[App] Found ${e.length} columns to initialize`),e.forEach(e=>{Drag.initOneColumn(e,this)})},initColumn(e){const t=e.getAttribute("data-lane-id"),s=e.getAttribute("data-status");console.log(`[App] initColumn (x-init): Lane ${t}, Status ${s}`),Drag.initOneColumn(e,this)},reinitSortableForLane(e){console.log(`[App] ====== Reinit Sortable for Lane ${e} ======`);const t=document.querySelectorAll(`.lane-column[data-lane-id="${e}"]`);console.log(`[App] Found ${t.length} columns for lane ${e}`),t.forEach(e=>{const t=e.getAttribute("data-status"),s=e.querySelectorAll(".task-card").length;console.log(`[App] Column ${t}: ${s} task cards`),e.sortableInstance&&(console.log(`[App] Destroying old Sortable for ${e.id}`),e.sortableInstance.destroy(),e.sortableInstance=null),Drag.initOneColumn(e,this)}),console.log(`[App] ====== Reinit Complete for Lane ${e} ======`)},getTasks(e,t){if(this.hideDone&&"DONE"===t)return[];if(this.showOnlyBlocked&&"BLOCKED"!==t)return[];let s=this.tasks.filter(s=>s.swimLane&&s.swimLane.id===e&&s.status===t);return this.selectedTags&&this.selectedTags.length>0&&(s=s.filter(e=>{const t=this.getTags(e.tags).map(e=>e.toLowerCase());return this.selectedTags.every(e=>t.includes(e.toLowerCase()))})),s.sort((e,t)=>(null!==e.position?e.position:999999)-(null!==t.position?t.position:999999)),s},getTags(e){if(Array.isArray(e))return e;try{return JSON.parse(e||"[]")}catch{return[]}},laneHasMatchingTasks(e){if(!this.selectedTags||0===this.selectedTags.length)return!0;return this.tasks.filter(t=>t.swimLane&&t.swimLane.id===e).some(e=>{const t=this.getTags(e.tags).map(e=>e.toLowerCase());return this.selectedTags.every(e=>t.includes(e.toLowerCase()))})},getAllUniqueTags(){const e=new Set;return this.tasks.forEach(t=>{this.getTags(t.tags).forEach(t=>e.add(t))}),Array.from(e).sort((e,t)=>e.toLowerCase().localeCompare(t.toLowerCase()))},toggleTag(e){const t=this.selectedTags.indexOf(e);this.selectedTags=t>-1?this.selectedTags.filter(t=>t!==e):[...this.selectedTags,e],console.log("[App] selectedTags:",this.selectedTags)},isTagSelected(e){return this.selectedTags.includes(e)},clearSelectedTags(){this.selectedTags=[]},resizingTaskId:null,resizeStartX:0,resizeStartY:0,resizeStartHeight:0,resizeLaneId:null,resizeStatus:null,taskSizes:{},expandedColumns:{},getTaskStyle(e){const t=this.taskSizes[e];return t?`height: ${t.height}px; min-height: ${t.height}px;`:""},startResize(e,t,s,i){console.log("[App] startResize:",{taskId:t,laneId:s,status:i});const o=e.target.closest(".task-card");o&&(this.resizingTaskId=t,this.resizeLaneId=s,this.resizeStatus=i,this.resizeStartX=e.clientX,this.resizeStartY=e.clientY,this.resizeStartHeight=o.offsetHeight,this.taskSizes[t]||(this.taskSizes[t]={height:o.offsetHeight,initialHeight:o.offsetHeight}),o.classList.add("resizing"),this._boundDoResize=this.doResize.bind(this),this._boundStopResize=this.stopResize.bind(this),document.addEventListener("mousemove",this._boundDoResize),document.addEventListener("mouseup",this._boundStopResize))},doResize(e){if(!this.resizingTaskId)return;const t=e.clientY-this.resizeStartY,s=e.clientX-this.resizeStartX,i=this.taskSizes[this.resizingTaskId],o=i.initialHeight||this.resizeStartHeight,a=2*o;let n=this.resizeStartHeight+t;n=Math.max(o,Math.min(a,n)),this.taskSizes[this.resizingTaskId]={...i,height:n},s>50?this.expandColumn(this.resizeLaneId,this.resizeStatus):s<-50&&this.shrinkColumn(this.resizeLaneId,this.resizeStatus)},stopResize(){if(console.log("[App] stopResize"),this.resizingTaskId){const e=document.querySelector(`[data-task-id="${this.resizingTaskId}"]`);e&&e.classList.remove("resizing")}this.resizingTaskId=null,this.resizeLaneId=null,this.resizeStatus=null,document.removeEventListener("mousemove",this._boundDoResize),document.removeEventListener("mouseup",this._boundStopResize)},expandColumn(e,t){console.log("[App] expandColumn:",{laneId:e,status:t});const s=document.querySelector(`[data-lane-id="${e}"].swimlane-row .swimlane-content`);if(!s)return;s.classList.add("has-expanded-column");s.querySelectorAll(".lane-column").forEach(e=>{e.getAttribute("data-status")===t?(e.classList.add("col-expanded"),e.classList.remove("col-shrunk")):(e.classList.add("col-shrunk"),e.classList.remove("col-expanded"))}),this.expandedColumns[e]=t},shrinkColumn(e,t){console.log("[App] shrinkColumn:",{laneId:e,status:t});const s=document.querySelector(`[data-lane-id="${e}"].swimlane-row .swimlane-content`);if(!s)return;s.classList.remove("has-expanded-column");s.querySelectorAll(".lane-column").forEach(e=>{e.classList.remove("col-expanded","col-shrunk")}),delete this.expandedColumns[e]},resetTaskSize(e){console.log("[App] resetTaskSize:",e);const t=this.taskSizes[e];t&&t.initialHeight?this.taskSizes[e]={...t,height:t.initialHeight}:delete this.taskSizes[e];const s=this.tasks.find(t=>t.id===e);s&&s.swimLane&&this.shrinkColumn(s.swimLane.id,s.status)}})),window.Alpine=Alpine,Alpine.start(),console.log("[App] ====== Alpine Started ======");