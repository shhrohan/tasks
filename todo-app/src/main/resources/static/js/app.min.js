import Alpine from"https://esm.sh/alpinejs@3.12.0";import{Store}from"./modules/store.min.js";import{Api}from"./modules/api.min.js";import{Drag}from"./modules/drag.min.js";console.log("[App] ====== Application Loading ======"),console.log("[App] Alpine.js ESM Module System"),console.log("[App] Modules imported: Store, Api, Drag"),Alpine.data("todoApp",()=>({lanes:[],tasks:[],showSaved:!1,columns:["TODO","IN_PROGRESS","DONE","BLOCKED","DEFERRED"],hideDone:!1,showOnlyBlocked:!1,selectedTags:[],isLoading:!0,mobileSidebarOpen:!1,sidebarPinned:!1,activeLaneId:null,isMobile:!1,selectedTaskId:null,prepareDrag(e){const t=document.querySelector(`[data-task-id="${e}"]`);t&&t.setAttribute("x-ignore","")},cleanupDrag(e){const t=document.querySelector(`[data-task-id="${e}"]`);t&&t.removeAttribute("x-ignore")},taskDetail:{open:!1,task:null,newComment:"",isLoading:!1,editingCommentId:null,editingCommentText:"",selectedCommentIndex:-1},...Store,async init(){console.log("[App] ====== Component Initializing ======"),document.addEventListener("click",e=>{e.target.closest(".task-card")&&console.log("[App] Task Card clicked:",{taskId:e.target.closest(".task-card").getAttribute("data-task-id"),target:e.target.tagName})},!0);try{const e=document.getElementById("initial-data");if(console.log("[App] DEBUG: Looking for #initial-data script tag..."),console.log("[App] DEBUG: dataScript element:",e),e){console.log("[App] Step 1: Found server-side initial data, parsing...");const t=e.textContent;console.log("[App] DEBUG: Raw JSON length:",t?t.length:0),console.log("[App] DEBUG: First 200 chars:",t?t.substring(0,200):"null");try{const e=JSON.parse(t);console.log("[App] DEBUG: JSON parsed successfully"),this.lanes=e.lanes||[],this.tasks=e.tasks||[],console.log(`[App] Loaded ${this.lanes.length} lanes and ${this.tasks.length} tasks from initial data`),this.lanes.forEach(e=>{const t=this.tasks.filter(t=>t.swimLane&&t.swimLane.id===e.id);e.loading=!1,e.collapsed=0===t.length}),this.$nextTick(()=>{this.lanes.forEach(e=>{this.reinitSortableForLane(e.id)})}),this.isLoading=!1}catch(e){console.error("[App] DEBUG: JSON parse failed:",e),console.log("[App] Falling back to API fetch due to parse error..."),await this.loadViaApi()}}else console.log("[App] Step 1: No initial data script found, falling back to API fetch..."),await this.loadViaApi()}catch(e){console.error("[App] Failed to initialize:",e)}this.$nextTick(()=>{console.log("[App] Step 3: Setting up lane-level drag..."),this.setupDrag()}),console.log("[App] Step 4: Initializing SSE connection..."),Api.initSSE(e=>this.onServerTaskUpdate(e),e=>this.onServerTaskDelete(e),e=>console.log("[App] SSE Lane update received:",e)),console.log("[App] ====== Initialization Complete ======"),this.checkMobile(),window.addEventListener("resize",()=>this.checkMobile()),this.lanes.length>0&&!this.activeLaneId&&(this.activeLaneId=this.lanes[0].id),this.$watch("selectedTags",e=>{const t=e.length>0;console.log("[App] Tag filter state changed. isFilterActive:",t),document.querySelectorAll(".lane-column").forEach(e=>{e.sortableInstance&&e.sortableInstance.option("disabled",t)});const s=document.querySelector(".board-container");s&&s.sortableInstance&&s.sortableInstance.option("disabled",t)}),document.addEventListener("keydown",e=>this.handleGlobalKeydown(e))},checkMobile(){const e=this.isMobile;this.isMobile=window.innerWidth<992,e&&!this.isMobile&&(this.mobileSidebarOpen=!1)},toggleMobileSidebar(){this.mobileSidebarOpen=!this.mobileSidebarOpen,console.log("[App] toggleMobileSidebar:",this.mobileSidebarOpen),this.updateSidebarBodyClasses()},selectLane(e){console.log("[App] selectLane:",e),this.activeLaneId=e,this.sidebarPinned||(this.mobileSidebarOpen=!1,this.updateSidebarBodyClasses()),window.scrollTo({top:0,behavior:"smooth"})},toggleSidebarPin(){this.sidebarPinned=!this.sidebarPinned,console.log("[App] toggleSidebarPin:",this.sidebarPinned),this.updateSidebarBodyClasses()},updateSidebarBodyClasses(){const e=document.body;this.mobileSidebarOpen?e.classList.add("sidebar-open"):e.classList.remove("sidebar-open"),this.sidebarPinned?e.classList.add("sidebar-pinned"):e.classList.remove("sidebar-pinned")},isLaneVisible(e){return this.isMobile?this.selectedTags.length>0?this.laneHasMatchingTasks(e):e===this.activeLaneId:this.laneHasMatchingTasks(e)},getLaneName(e){const t=this.lanes.find(t=>t.id===e);return t?t.name:""},async loadViaApi(){console.log("[App] loadViaApi: Starting async API fetch...");const e=await Store.loadData();this.lanes=e.lanes,console.log(`[App] Loaded ${this.lanes.length} lanes via API`);const t=this.lanes.map(async e=>{try{const t=await Store.fetchLaneTasks(e.id);this.tasks.push(...t);const s=this.lanes.find(t=>t.id===e.id);s&&(s.loading=!1,s.collapsed=0===t.length),this.$nextTick(()=>{this.reinitSortableForLane(e.id)})}catch(t){console.error(`[App] Error fetching tasks for lane ${e.id}:`,t)}});await Promise.all(t),console.log("[App] All lanes loaded via API"),this.isLoading=!1},setupDrag(){console.log("[App] setupDrag: Initializing board-level drag (swimlanes)");const e=document.querySelector(".board-container");e?Drag.initLaneSortable(e,this,()=>{console.log("[App] Lane reorder complete, callback fired")}):console.error("[App] ERROR: .board-container not found!")},setupTaskSortables(){console.warn("[App] setupTaskSortables called - this may init empty columns!");const e=document.querySelectorAll(".lane-column");console.log(`[App] Found ${e.length} columns to initialize`),e.forEach(e=>{Drag.initOneColumn(e,this)})},initColumn(e){const t=e.getAttribute("data-lane-id"),s=e.getAttribute("data-status");console.log(`[App] initColumn (x-init): Lane ${t}, Status ${s}`),Drag.initOneColumn(e,this)},reinitSortableForLane(e){document.getElementById(`lane-${e}-container`);const t=document.querySelectorAll(`.lane-column[data-lane-id="${e}"]`);0!==t.length?(t.forEach(e=>{e.sortableInstance&&(e.sortableInstance.destroy(),e.sortableInstance=null),Drag.initOneColumn(e,this,Alpine)}),console.log(`[App] ====== Reinit Complete for Lane ${e} ======`)):console.warn(`[App] reinitSortableForLane: No columns found for lane ${e}`)},getTasks(e,t){if(this.hideDone&&"DONE"===t)return[];if(this.showOnlyBlocked&&"BLOCKED"!==t)return[];let s=this.tasks.filter(s=>s.swimLane&&s.swimLane.id===e&&s.status===t);return this.selectedTags&&this.selectedTags.length>0&&(s=s.filter(e=>{const t=this.getTags(e.tags).map(e=>e.toLowerCase());return this.selectedTags.every(e=>t.includes(e.toLowerCase()))})),s.sort((e,t)=>(null!==e.position?e.position:999999)-(null!==t.position?t.position:999999)),s},getTags(e){if(Array.isArray(e))return e;try{return JSON.parse(e||"[]")}catch{return[]}},laneHasMatchingTasks(e){if(!this.selectedTags||0===this.selectedTags.length)return!0;return this.tasks.filter(t=>t.swimLane&&t.swimLane.id===e).some(e=>{const t=this.getTags(e.tags).map(e=>e.toLowerCase());return this.selectedTags.every(e=>t.includes(e.toLowerCase()))})},columnHasMatchingTasks(e,t){return!this.selectedTags||0===this.selectedTags.length||this.getTasks(e,t).length>0},isColumnVisible(e,t){if(!this.isMobile)return!0;if(!this.selectedTags||0===this.selectedTags.length)return!0;const s=this.columnHasMatchingTasks(e,t);return s||console.log(`[App] Hiding empty column ${t} for lane ${e} in mobile filter view`),s},getAllUniqueTags(){const e=new Set;return this.tasks.forEach(t=>{this.getTags(t.tags).forEach(t=>e.add(t))}),Array.from(e).sort((e,t)=>e.toLowerCase().localeCompare(t.toLowerCase()))},toggleTag(e){const t=this.selectedTags.indexOf(e);this.selectedTags=t>-1?this.selectedTags.filter(t=>t!==e):[...this.selectedTags,e],console.log("[App] selectedTags:",this.selectedTags)},isTagSelected(e){return this.selectedTags.includes(e)},clearSelectedTags(){this.selectedTags=[]},resizingTaskId:null,resizeStartX:0,resizeStartY:0,resizeStartHeight:0,resizeLaneId:null,resizeStatus:null,taskSizes:{},expandedColumns:{},getTaskStyle(e){const t=this.taskSizes[e];return t?`height: ${t.height}px; min-height: ${t.height}px;`:""},startResize(e,t,s,i){console.log("[App] startResize:",{taskId:t,laneId:s,status:i});const n=e.target.closest(".task-card");n&&(this.resizingTaskId=t,this.resizeLaneId=s,this.resizeStatus=i,this.resizeStartX=e.clientX,this.resizeStartY=e.clientY,this.resizeStartHeight=n.offsetHeight,this.taskSizes[t]||(this.taskSizes[t]={height:n.offsetHeight,initialHeight:n.offsetHeight}),n.classList.add("resizing"),this._boundDoResize=this.doResize.bind(this),this._boundStopResize=this.stopResize.bind(this),document.addEventListener("mousemove",this._boundDoResize),document.addEventListener("mouseup",this._boundStopResize))},doResize(e){if(!this.resizingTaskId)return;const t=e.clientY-this.resizeStartY,s=e.clientX-this.resizeStartX,i=this.taskSizes[this.resizingTaskId],n=i.initialHeight||this.resizeStartHeight,a=2*n;let o=this.resizeStartHeight+t;o=Math.max(n,Math.min(a,o)),this.taskSizes[this.resizingTaskId]={...i,height:o},s>50?this.expandColumn(this.resizeLaneId,this.resizeStatus):s<-50&&this.shrinkColumn(this.resizeLaneId,this.resizeStatus)},stopResize(){if(console.log("[App] stopResize"),this.resizingTaskId){const e=document.querySelector(`[data-task-id="${this.resizingTaskId}"]`);e&&e.classList.remove("resizing")}this.resizingTaskId=null,this.resizeLaneId=null,this.resizeStatus=null,document.removeEventListener("mousemove",this._boundDoResize),document.removeEventListener("mouseup",this._boundStopResize)},expandColumn(e,t){console.log("[App] expandColumn:",{laneId:e,status:t});const s=document.querySelector(`[data-lane-id="${e}"].swimlane-row .swimlane-content`);if(!s)return;s.classList.add("has-expanded-column");s.querySelectorAll(".lane-column").forEach(e=>{e.getAttribute("data-status")===t?(e.classList.add("col-expanded"),e.classList.remove("col-shrunk")):(e.classList.add("col-shrunk"),e.classList.remove("col-expanded"))}),this.expandedColumns[e]=t},shrinkColumn(e,t){console.log("[App] shrinkColumn:",{laneId:e,status:t});const s=document.querySelector(`[data-lane-id="${e}"].swimlane-row .swimlane-content`);if(!s)return;s.classList.remove("has-expanded-column");s.querySelectorAll(".lane-column").forEach(e=>{e.classList.remove("col-expanded","col-shrunk")}),delete this.expandedColumns[e]},resetTaskSize(e){console.log("[App] resetTaskSize:",e);const t=this.taskSizes[e];t&&t.initialHeight?this.taskSizes[e]={...t,height:t.initialHeight}:delete this.taskSizes[e];const s=this.tasks.find(t=>t.id===e);s&&s.swimLane&&this.shrinkColumn(s.swimLane.id,s.status)},openTaskDetail(e){if(this.isMobile)return;console.log("[App] openTaskDetail:",e);const t=this.tasks.find(t=>t.id===e);t&&(this.taskDetail.task=t,this.taskDetail.open=!0,this.taskDetail.newComment="")},closeTaskDetail(){console.log("[App] closeTaskDetail"),this.taskDetail.open=!1,this.taskDetail.selectedCommentIndex=-1,setTimeout(()=>{this.taskDetail.task=null},300)},handleDetailKeydown(e){if(console.log("[App] handleDetailKeydown:",{key:e.key,altKey:e.altKey,ctrlKey:e.ctrlKey,shiftKey:e.shiftKey,taskDetailOpen:this.taskDetail.open,selectedCommentIndex:this.taskDetail.selectedCommentIndex}),!this.taskDetail.open)return void console.log("[App] handleDetailKeydown: Pane not open, ignoring");const t=this.getTaskComments(this.taskDetail.task);if(console.log("[App] handleDetailKeydown: Comments count:",t.length),"Escape"===e.key)return console.log("[App] handleDetailKeydown: ESC pressed, closing pane"),this.closeTaskDetail(),void e.preventDefault();if("Enter"===e.key&&e.altKey)return console.log("[App] handleDetailKeydown: Alt+Enter pressed"),this.taskDetail.newComment.trim()&&(console.log("[App] handleDetailKeydown: Submitting comment"),this.addComment()),void e.preventDefault();if("ArrowUp"===e.key&&!this.taskDetail.editingCommentId)return console.log("[App] handleDetailKeydown: ArrowUp pressed"),0===t.length?void console.log("[App] handleDetailKeydown: No comments to navigate"):(-1===this.taskDetail.selectedCommentIndex?this.taskDetail.selectedCommentIndex=t.length-1:this.taskDetail.selectedCommentIndex>0&&this.taskDetail.selectedCommentIndex--,console.log("[App] handleDetailKeydown: New selectedCommentIndex:",this.taskDetail.selectedCommentIndex),this.scrollToSelectedComment(),void e.preventDefault());if("ArrowDown"===e.key&&!this.taskDetail.editingCommentId)return console.log("[App] handleDetailKeydown: ArrowDown pressed"),0===t.length?void console.log("[App] handleDetailKeydown: No comments to navigate"):(this.taskDetail.selectedCommentIndex<t.length-1&&this.taskDetail.selectedCommentIndex++,console.log("[App] handleDetailKeydown: New selectedCommentIndex:",this.taskDetail.selectedCommentIndex),this.scrollToSelectedComment(),void e.preventDefault());if("Enter"===e.key&&!e.altKey&&!e.ctrlKey&&-1!==this.taskDetail.selectedCommentIndex){console.log("[App] handleDetailKeydown: Enter pressed on selected comment index:",this.taskDetail.selectedCommentIndex);const s=t[this.taskDetail.selectedCommentIndex];return s&&(console.log("[App] handleDetailKeydown: Starting edit for comment ID:",s.id),this.startEditComment(s)),void e.preventDefault()}},scrollToSelectedComment(){this.$nextTick(()=>{const e=document.querySelector(".comment-item.comment-selected");e&&e.scrollIntoView({behavior:"smooth",block:"nearest"})})},isCommentSelected(e){return this.taskDetail.selectedCommentIndex===e},handleGlobalKeydown(e){const t=document.activeElement;(!t||"INPUT"!==t.tagName&&"TEXTAREA"!==t.tagName)&&(console.log("[App] handleGlobalKeydown:",{key:e.key,altKey:e.altKey,ctrlKey:e.ctrlKey,taskDetailOpen:this.taskDetail.open}),this.taskDetail.open?this.handleDetailKeydown(e):this.handleMainViewKeydown(e))},handleMainViewKeydown(e){if(console.log("[App] handleMainViewKeydown:",e.key)," "!==e.key&&"Space"!==e.key)return"Escape"===e.key?(console.log("[App] Escape pressed - clearing task selection"),void(this.selectedTaskId=null)):["ArrowUp","ArrowDown","ArrowLeft","ArrowRight"].includes(e.key)?(this.navigateTask(e.key),void e.preventDefault()):void 0;this.selectedTaskId&&(console.log("[App] Space pressed - opening task detail:",this.selectedTaskId),this.openTaskDetail(this.selectedTaskId),e.preventDefault())},navigateTask(e){if(console.log("[App] navigateTask:",e,"current:",this.selectedTaskId),!this.selectedTaskId){const e=this.getFirstVisibleTask();return void(e&&(this.selectedTaskId=e.id,this.scrollToSelectedTask()))}const t=this.tasks.find(e=>e.id===this.selectedTaskId);if(!t)return void(this.selectedTaskId=null);let s=null;switch(e){case"ArrowUp":s=this.getTaskAbove(t);break;case"ArrowDown":s=this.getTaskBelow(t);break;case"ArrowLeft":s=this.getTaskInPreviousColumn(t);break;case"ArrowRight":s=this.getTaskInNextColumn(t)}s&&(console.log("[App] Navigating to task:",s.id,s.name),this.selectedTaskId=s.id,this.scrollToSelectedTask())},getFirstVisibleTask(){const e=this.lanes.find(e=>!e.collapsed&&this.laneHasMatchingTasks(e.id));if(!e)return null;for(const t of this.columns){const s=this.getTasks(e.id,t);if(s.length>0)return s[0]}return null},getTaskAbove(e){const t=e.swimLane?.id;if(!t)return null;const s=this.getTasks(t,e.status),i=s.findIndex(t=>t.id===e.id);return i>0?s[i-1]:this.getTaskInPreviousLane(e)},getTaskBelow(e){const t=e.swimLane?.id;if(!t)return null;const s=this.getTasks(t,e.status),i=s.findIndex(t=>t.id===e.id);return i<s.length-1?s[i+1]:this.getTaskInNextLane(e)},getTaskInPreviousColumn(e){const t=e.swimLane?.id;if(!t)return null;const s=this.columns.indexOf(e.status);if(s<=0)return null;for(let e=s-1;e>=0;e--){const s=this.getTasks(t,this.columns[e]);if(s.length>0)return s[0]}return null},getTaskInNextColumn(e){const t=e.swimLane?.id;if(!t)return null;const s=this.columns.indexOf(e.status);if(s>=this.columns.length-1)return null;for(let e=s+1;e<this.columns.length;e++){const s=this.getTasks(t,this.columns[e]);if(s.length>0)return s[0]}return null},getTaskInPreviousLane(e){const t=this.lanes.findIndex(t=>t.id===e.swimLane?.id);if(t<=0)return null;for(let s=t-1;s>=0;s--){const t=this.lanes[s];if(t.collapsed||!this.laneHasMatchingTasks(t.id))continue;const i=this.getTasks(t.id,e.status);if(i.length>0)return i[i.length-1]}return null},getTaskInNextLane(e){const t=this.lanes.findIndex(t=>t.id===e.swimLane?.id);if(t>=this.lanes.length-1)return null;for(let s=t+1;s<this.lanes.length;s++){const t=this.lanes[s];if(t.collapsed||!this.laneHasMatchingTasks(t.id))continue;const i=this.getTasks(t.id,e.status);if(i.length>0)return i[0]}return null},scrollToSelectedTask(){this.$nextTick(()=>{const e=document.querySelector(".task-card.task-selected");e&&e.scrollIntoView({behavior:"smooth",block:"nearest"})})},isTaskSelected(e){return this.selectedTaskId===e},getTaskComments:e=>e&&e.comments&&Array.isArray(e.comments)?e.comments:[],async addComment(){const e=this.taskDetail.newComment.trim();if(e&&this.taskDetail.task){console.log("[App] addComment:",e),this.taskDetail.isLoading=!0;try{const t=this.taskDetail.task.id,s=await Api.addComment(t,e),i=this.tasks.find(e=>e.id===t);i&&(i.comments||(i.comments=[]),i.comments.push(s),this.taskDetail.newComment="",this.taskDetail.task.id===i.id&&(this.taskDetail.task={...i})),this.triggerSave()}catch(e){console.error("[App] Failed to add comment:",e),this.showError("Failed to add comment")}finally{this.taskDetail.isLoading=!1}}},startEditComment(e){this.taskDetail.editingCommentId=e.id,this.taskDetail.editingCommentText=e.text||e},cancelEditComment(){this.taskDetail.editingCommentId=null,this.taskDetail.editingCommentText=""},async updateComment(){const e=this.taskDetail.editingCommentText.trim(),t=this.taskDetail.editingCommentId;if(e&&t&&this.taskDetail.task){this.taskDetail.isLoading=!0;try{const s=this.taskDetail.task.id,i=await Api.updateComment(s,t,e),n=this.tasks.find(e=>e.id==s);if(n&&n.comments){const e=n.comments.findIndex(e=>e.id==t);-1!==e&&(n.comments[e]=i,this.taskDetail.task={...n})}this.cancelEditComment(),this.triggerSave()}catch(e){console.error("[App] Failed to update comment:",e),this.showError("Failed to update comment")}finally{this.taskDetail.isLoading=!1}}},deleteComment(e){this.taskDetail.task&&this.confirmAction("deleteComment",e)},async executeDeleteComment(e){if(this.taskDetail.task)if(this.isDeletingComment)console.warn("[App] executeDeleteComment - Already deleting, ignoring");else{this.isDeletingComment=!0,this.taskDetail.isLoading=!0;try{const t=this.taskDetail.task.id;await Api.deleteComment(t,e);const s=this.tasks.find(e=>e.id==t);s&&s.comments&&(s.comments=s.comments.filter(t=>t.id!=e),this.taskDetail.task={...s}),this.triggerSave()}catch(e){console.error("[App] Failed to delete comment:",e),this.showError("Failed to delete comment")}finally{this.isDeletingComment=!1,this.taskDetail.isLoading=!1,this.closeModal()}}}})),window.Alpine=Alpine,Alpine.start(),console.log("[App] ====== Alpine Started ======");