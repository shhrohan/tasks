<!DOCTYPE html>
<!--
============================================================================
INDEX.HTML - 3D Task Board Main Template
============================================================================

DRAG-AND-DROP CRITICAL NOTES:
=============================

1. TASK CARDS MUST HAVE draggable="true"
   - Without this, native HTML5 drag won't work
   - Sortable uses this attribute for drag detection

2. x-init="initColumn($el)" fires when column is CREATED, NOT when tasks load
   - Tasks are loaded asynchronously AFTER columns exist
   - app.js calls reinitSortableForLane() after tasks load to fix this

3. COLUMN STRUCTURE for Sortable:
   .lane-column (Sortable container)
     └── .task-card (draggable items - must have data-task-id)

4. DATA ATTRIBUTES:
   - data-lane-id  : Required on .lane-column for API calls
   - data-status   : Required on .lane-column for status updates
   - data-task-id  : Required on .task-card for identifying which task moved

5. DO NOT ADD CSS 3D TRANSFORMS to task-card or parent elements
   - See style.css header for full explanation
   - Use box-shadow instead for depth effects

============================================================================
-->
<html lang="en" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3D Task Board</title>

    <!-- Critical CSS (inlined for fastest first paint) -->
    <style>
        /* Critical above-the-fold styles - renders immediately */
        :root {
            --bg-color: #0f172a;
            --card-bg: rgba(30, 41, 59, 0.8);
            --text-primary: #f1f5f9;
            --glass-border: 1px solid rgba(255, 255, 255, 0.1);
        }

        body {
            background-color: #0f172a !important;
            color: #f1f5f9;
            min-height: 100vh;
            margin: 0;
        }

        [x-cloak] {
            display: none !important;
        }

        .glass-panel {
            background: rgba(30, 41, 59, 0.8);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .navbar {
            padding: 0.5rem 1rem;
        }

        .navbar-brand {
            font-weight: bold;
            color: #f1f5f9 !important;
        }

        .board-container {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
    </style>

    <!-- Preconnect to CDNs for faster resource loading -->
    <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
    <link rel="preconnect" href="https://cdnjs.cloudflare.com" crossorigin>
    <link rel="dns-prefetch" href="https://cdn.jsdelivr.net">
    <link rel="dns-prefetch" href="https://cdnjs.cloudflare.com">

    <!-- Preload critical CSS -->
    <link rel="preload" href="/css/style.min.css" as="style">
    <link rel="preload" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" as="style">

    <!-- Critical CSS (render-blocking, needed for initial paint) -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/css/style.min.css">

    <!-- Non-critical CSS (async load with media trick) -->
    <!-- Font Awesome - Full version for debugging -->
    <link rel="stylesheet" href="/css/fontawesome.purged.css" media="print" onload="this.media='all'">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" media="print"
        onload="this.media='all'">
    <!-- Fallback for no-JS -->
    <noscript>
        <link rel="stylesheet" href="/css/fontawesome.purged.css">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css">
    </noscript>

    <!-- Favicon -->
    <link rel="icon" type="image/png" href="/favicon.png">
</head>

<!-- Initial Data: Embedded via data attribute to avoid JS escaping issues -->
<script id="initial-data" type="application/json" th:if="${initialDataJson != null}" th:utext="${initialDataJson}">
{"lanes":[],"tasks":[]}
</script>

<body class="bg-dark text-white" x-data="todoApp">

    <!-- Navbar -->
    <nav class="navbar navbar-dark glass-panel sticky-top mb-4">
        <div class="container-fluid">
            <!-- Mobile: Sidebar Toggle (hidden on desktop) -->
            <button class="btn btn-outline-light btn-sm d-lg-none me-2 mobile-sidebar-toggle"
                @click="toggleMobileSidebar()" :class="{'active': mobileSidebarOpen}" title="Switch Swimlane">
                <i class="fa-solid fa-bars"></i>
            </button>

            <a class="navbar-brand fw-bold" href="#">
                <i class="fa-solid fa-cubes me-2"></i><span class="d-none d-sm-inline">TaskBoard 3D</span><span
                    class="d-sm-none">Tasks</span>
            </a>

            <div class="d-flex align-items-center gap-2 gap-lg-3">
                <!-- Collapse/Expand All Button (hidden on mobile) -->
                <button class="btn btn-outline-light btn-sm d-none d-lg-flex align-items-center gap-2"
                    @click="toggleAllLanes()"
                    :title="areAllLanesCollapsed() ? 'Expand All Lanes' : 'Collapse All Lanes'">
                    <i class="fa-solid" :class="areAllLanesCollapsed() ? 'fa-expand' : 'fa-compress'"></i>
                    <span x-text="areAllLanesCollapsed() ? 'Expand All' : 'Collapse All'"></span>
                </button>

                <!-- Filter Buttons -->
                <div class="btn-group" role="group">
                    <button type="button" class="btn btn-sm" :class="hideDone ? 'btn-success' : 'btn-outline-secondary'"
                        @click="hideDone = !hideDone; showOnlyBlocked = false" title="Hide completed tasks">
                        <i class="fa-solid fa-eye-slash"></i><span class="d-none d-lg-inline ms-1">Hide Done</span>
                    </button>
                    <button type="button" class="btn btn-sm"
                        :class="showOnlyBlocked ? 'btn-danger' : 'btn-outline-secondary'"
                        @click="showOnlyBlocked = !showOnlyBlocked; hideDone = false" title="Show only blocked tasks">
                        <i class="fa-solid fa-ban"></i><span class="d-none d-lg-inline ms-1">Blocked Only</span>
                    </button>
                </div>

                <!-- Add Swimlane Button -->
                <button class="btn btn-primary btn-sm" @click="openSwimlaneModal()">
                    <i class="fa-solid fa-plus"></i><span class="d-none d-lg-inline ms-1">New Board</span>
                </button>

                <!-- User/Logout -->
                <div class="dropdown">
                    <button class="btn btn-outline-light btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown"
                        aria-expanded="false">
                        <i class="fa-solid fa-user"></i>
                        <span class="d-none d-lg-inline ms-1" th:text="${#authentication?.name ?: 'User'}">User</span>
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end dropdown-menu-dark">
                        <li>
                            <form th:action="@{/logout}" method="post" class="m-0">
                                <button type="submit" class="dropdown-item">
                                    <i class="fa-solid fa-sign-out-alt me-2"></i>Logout
                                </button>
                            </form>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </nav>

    <!-- Mobile Sidebar Drawer (Swimlane Navigation) -->
    <div class="mobile-sidebar-backdrop" x-show="mobileSidebarOpen && isMobile"
        x-transition:enter="transition ease-out duration-300" x-transition:enter-start="opacity-0"
        x-transition:enter-end="opacity-100" x-transition:leave="transition ease-in duration-200"
        x-transition:leave-start="opacity-100" x-transition:leave-end="opacity-0" @click="mobileSidebarOpen = false"
        x-cloak>
    </div>

    <aside class="mobile-sidebar" x-show="mobileSidebarOpen && isMobile"
        x-transition:enter="transition ease-out duration-300" x-transition:enter-start="sidebar-hidden"
        x-transition:enter-end="sidebar-visible" x-transition:leave="transition ease-in duration-200"
        x-transition:leave-start="sidebar-visible" x-transition:leave-end="sidebar-hidden" x-cloak>


        <!-- Swimlane List -->
        <div class="mobile-sidebar-body">
            <template x-for="lane in lanes" :key="lane.id">
                <button class="sidebar-lane-item" :class="{'active': activeLaneId === lane.id}"
                    @click="selectLane(lane.id)">
                    <span class="lane-name" x-text="lane.name"></span>
                    <div class="lane-progress-ring">
                        <!-- Circular progress indicator -->
                        <svg class="progress-circle" viewBox="0 0 36 36">
                            <path class="progress-bg"
                                d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" />
                            <path class="progress-bar" :stroke-dasharray="getLaneStats(lane.id).donePct + ', 100'"
                                d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" />
                        </svg>
                        <!-- Percentage or checkmark -->
                        <span class="progress-text" x-show="activeLaneId !== lane.id"
                            x-text="getLaneStats(lane.id).donePct + '%'"></span>
                        <i class="fa-solid fa-check progress-check" x-show="activeLaneId === lane.id"></i>
                    </div>
                </button>
            </template>
        </div>
    </aside>

    <!-- Tag Filter Bar (Collapsible on mobile) -->
    <div class="tag-filter-bar glass-panel px-3 py-2" x-show="getAllUniqueTags().length > 0" x-data="{expanded: false}">
        <div class="d-flex align-items-center justify-content-between">
            <button class="btn btn-sm btn-link text-secondary p-0 d-flex align-items-center gap-2"
                @click="expanded = !expanded">
                <i class="fa-solid fa-tags"></i>
                <span class="d-none d-lg-inline">Filter by tag:</span>
                <span class="d-lg-none"
                    x-text="expanded ? 'Hide tags' : 'Tags (' + getAllUniqueTags().length + ')'"></span>
                <i class="fa-solid d-lg-none" :class="expanded ? 'fa-chevron-up' : 'fa-chevron-down'"></i>
            </button>
            <span x-show="selectedTags.length > 0" class="badge bg-info">
                <span x-text="selectedTags.length"></span> active
            </span>
        </div>
        <!-- Desktop: Always show all tags -->
        <div class="d-none d-lg-flex align-items-center gap-2 flex-wrap mt-2">
            <template x-for="tag in getAllUniqueTags()" :key="tag">
                <button class="tag-capsule" :class="{'active': isTagSelected(tag)}" @click="toggleTag(tag)"
                    x-text="tag">
                </button>
            </template>
            <button class="btn btn-link btn-sm text-secondary p-0 ms-2" x-show="selectedTags.length > 0"
                @click="clearSelectedTags()" title="Clear all filters">
                <i class="fa-solid fa-times-circle"></i> Clear
            </button>
        </div>
        <!-- Mobile: Expandable tag list -->
        <div class="d-lg-none mt-2" x-show="expanded" x-transition>
            <div class="d-flex align-items-center gap-2 flex-wrap">
                <template x-for="tag in getAllUniqueTags()" :key="tag">
                    <button class="tag-capsule" :class="{'active': isTagSelected(tag)}" @click="toggleTag(tag)"
                        x-text="tag">
                    </button>
                </template>
                <button class="btn btn-link btn-sm text-secondary p-0 ms-2" x-show="selectedTags.length > 0"
                    @click="clearSelectedTags()" title="Clear all filters">
                    <i class="fa-solid fa-times-circle"></i> Clear
                </button>
            </div>
        </div>
    </div>

    <!-- Main Content Area (accessibility landmark) -->
    <main class="container-fluid px-4 pb-5" role="main">

        <!-- Dashboard Layout -->
        <div class="dashboard-layout position-relative">

            <!-- LEFT: Board Area -->
            <div class="board-area">

                <!-- Headers -->
                <div class="row board-header-row mb-3 d-none d-lg-flex gap-3">
                    <div class="col-2 header-spacer"></div> <!-- Spacer for Lane Headers -->
                    <template x-for="col in columns" :key="col">
                        <div class="col status-header" :class="'status-' + col.toLowerCase()">
                            <h2 x-text="col.replace('_', ' ')"></h2>
                        </div>
                    </template>
                </div>

                <!-- Swimlanes Container -->
                <div class="board-container">
                    <!-- Loop Swimlanes -->
                    <template x-for="lane in lanes" :key="lane.id">
                        <div class="row mb-3 mb-lg-4 swimlane-row" :data-lane-id="lane.id"
                            x-show="isLaneVisible(lane.id)" x-transition:leave="transition ease-in duration-200"
                            x-transition:leave-start="opacity-100" x-transition:leave-end="opacity-0">

                            <!-- Swimlane Header -->
                            <div class="swimlane-header p-3" @click="toggleLaneCollapse(lane.id)"
                                style="cursor: pointer;">
                                <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
                                    <!-- Left: Title & Stats + Action Button on mobile -->
                                    <div class="d-flex align-items-center gap-2 gap-lg-3 flex-grow-1">
                                        <!-- Collapse chevron: Show on mobile when tag filters active -->
                                        <i class="fa-solid" :class="[lane.collapsed ? 'fa-chevron-right' : 'fa-chevron-down', 
                                                     selectedTags.length > 0 ? '' : 'd-none d-lg-inline']"></i>
                                        <!-- Lane name on both mobile and desktop -->
                                        <span class="h5 mb-0 fw-bold d-lg-none" x-text="lane.name"></span>
                                        <span class="h4 mb-0 fw-bold d-none d-lg-inline" x-text="lane.name"></span>
                                        <span class="badge bg-primary rounded-pill"
                                            x-text="getLaneStats(lane.id).total"></span>
                                        <div x-show="lane.loading" class="spinner-border spinner-border-sm text-primary"
                                            role="status"></div>

                                        <!-- Mobile: Mark As Done button -->
                                        <button class="btn btn-sm btn-outline-success d-lg-none px-2 py-1"
                                            @click.stop="confirmAction('completeLane', lane.id)" title="Mark As Done">
                                            <i class="fa-solid fa-circle-check me-1"></i>
                                            <span class="small">Done</span>
                                        </button>
                                    </div>

                                    <!-- Center: Progress Bar (Inline in Header) - Desktop only -->
                                    <div class="swimlane-progress-inline flex-grow-1 mx-3 ms-auto d-none d-lg-flex"
                                        x-show="getLaneStats(lane.id).total > 0" @click.stop>
                                        <div class="d-flex align-items-center gap-2 w-100">
                                            <!-- Todo -->
                                            <template x-if="getLaneStats(lane.id).todo > 0">
                                                <div class="badge rounded-pill bg-secondary shadow-sm status-pill-lg"
                                                    :style="'flex-grow: ' + getLaneStats(lane.id).todo"
                                                    x-text="getLaneStats(lane.id).todoPct + '% (' + getLaneStats(lane.id).todo + ')'"
                                                    title="Todo"></div>
                                            </template>

                                            <!-- In Progress -->
                                            <template x-if="getLaneStats(lane.id).inProgress > 0">
                                                <div class="badge rounded-pill bg-primary shadow-sm status-pill-lg"
                                                    :style="'flex-grow: ' + getLaneStats(lane.id).inProgress"
                                                    x-text="getLaneStats(lane.id).inProgressPct + '% (' + getLaneStats(lane.id).inProgress + ')'"
                                                    title="In Progress"></div>
                                            </template>

                                            <!-- Done -->
                                            <template x-if="getLaneStats(lane.id).done > 0">
                                                <div class="badge rounded-pill bg-success shadow-sm status-pill-lg"
                                                    :style="'flex-grow: ' + getLaneStats(lane.id).done"
                                                    x-text="getLaneStats(lane.id).donePct + '% (' + getLaneStats(lane.id).done + ')'"
                                                    title="Done"></div>
                                            </template>

                                            <!-- Blocked -->
                                            <template x-if="getLaneStats(lane.id).blocked > 0">
                                                <div class="badge rounded-pill bg-danger shadow-sm status-pill-lg"
                                                    :style="'flex-grow: ' + getLaneStats(lane.id).blocked"
                                                    x-text="getLaneStats(lane.id).blockedPct + '% (' + getLaneStats(lane.id).blocked + ')'"
                                                    title="Blocked"></div>
                                            </template>

                                            <!-- Deferred -->
                                            <template x-if="getLaneStats(lane.id).deferred > 0">
                                                <div class="badge rounded-pill bg-warning text-dark shadow-sm status-pill-lg"
                                                    :style="'flex-grow: ' + getLaneStats(lane.id).deferred"
                                                    x-text="getLaneStats(lane.id).deferredPct + '% (' + getLaneStats(lane.id).deferred + ')'"
                                                    title="Deferred"></div>
                                            </template>
                                        </div>
                                    </div>

                                    <!-- Right: Actions - Desktop only (mobile button is inline above) -->
                                    <div class="d-none d-lg-flex gap-2 ms-auto">
                                        <button class="btn btn-sm btn-outline-success"
                                            @click.stop="confirmAction('completeLane', lane.id)"
                                            title="Mark As Completed">
                                            <i class="fa-solid fa-check me-2"></i>Mark As Completed
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <!-- Swimlane Body (Columns) -->
                            <div class="swimlane-content row g-3 px-3 pb-3 pt-0" x-show="!lane.collapsed" x-transition>
                                <!-- Add Task Button Col -->
                                <div
                                    class="col-12 col-lg-2 d-flex align-items-center justify-content-center border-end border-secondary">
                                    <button class="btn btn-outline-primary btn-sm" @click.stop="openTaskModal(lane.id)">
                                        <i class="fa-solid fa-plus"></i> Add Task
                                    </button>
                                </div>

                                <!-- 
                                    STATUS COLUMNS (Sortable Containers)
                                    ====================================
                                    - x-init fires when column HTML is created (BEFORE tasks load!)
                                    - initColumn() calls Drag.initOneColumn() 
                                    - reinitSortableForLane() is called AFTER tasks load to fix this
                                    - data-status and data-lane-id are REQUIRED for API calls
                                -->
                                <template x-for="status in columns" :key="status">
                                    <div class="col-12 col-lg lane-column" :id="'lane-' + lane.id + '-' + status"
                                        :data-status="status" :data-lane-id="lane.id" x-init="initColumn($el)"
                                        x-show="isColumnVisible(lane.id, status)">

                                        <!-- 
                                            TASK CARDS (Draggable Items)
                                            ============================
                                            - draggable="true" is REQUIRED for HTML5 drag
                                            - data-task-id is REQUIRED for identifying moved task
                                            - DO NOT add 3D transforms (translateZ, rotateX) - breaks drag!
                                        -->

                                        <!-- TASK CARDS (Draggable Items) -->
                                        <template x-for="task in getTasks(lane.id, status)" :key="task.id">
                                            <div class="card task-card mb-2" :data-task-id="task.id"
                                                :data-status="task.status" :draggable="!selectedTags.length"
                                                :style="getTaskStyle(task.id)" @dblclick="resetTaskSize(task.id)"
                                                @click="openTaskDetail(task.id)"
                                                @mousedown.passive="prepareDrag(task.id)"
                                                @touchstart.passive="prepareDrag(task.id)"
                                                @mouseup="cleanupDrag(task.id)" @touchend="cleanupDrag(task.id)"
                                                :class="{'task-selected': isTaskSelected(task.id)}">
                                                <div class="card-body p-2 d-flex flex-column h-100">
                                                    <p class="h6 card-title text-white mb-1" x-text="task.name"></p>
                                                    <div class="d-flex align-items-center gap-2 mt-auto">
                                                        <!-- Comment Count -->
                                                        <template x-if="getTaskComments(task).length > 0">
                                                            <div class="comment-count-badge small text-white-50"
                                                                title="Comments">
                                                                <i class="fa-regular fa-comment me-1"></i>
                                                                <span x-text="getTaskComments(task).length"></span>
                                                            </div>
                                                        </template>

                                                        <!-- Tags: ms-auto to push tags to the right -->
                                                        <div class="d-flex flex-wrap gap-1 ms-auto justify-content-end">
                                                            <template x-for="tag in getTags(task.tags)" :key="tag">
                                                                <span
                                                                    class="badge border border-secondary text-white fw-normal"
                                                                    style="font-size: 0.9rem; letter-spacing: 0.03em;"
                                                                    x-text="tag"></span>
                                                            </template>
                                                        </div>
                                                    </div>
                                                </div>
                                                <!-- Resize handle -->
                                                <div class="resize-handle"
                                                    @mousedown.stop.prevent="startResize($event, task.id, lane.id, status)">
                                                </div>
                                            </div>
                                        </template>

                                    </div>
                                </template>
                            </div>

                        </div>
                    </template>
                </div>
            </div>
            <!-- End Board Area -->

        </div>
        <!-- End Dashboard Layout -->

        </div>

        <!-- Modals -->

        <!-- Notifications -->
        <!-- Saved Notification -->
        <div class="notification-toast success" x-show="showSaved" x-cloak
            x-transition:enter="transition ease-out duration-300"
            x-transition:enter-start="opacity-0 transform -translate-y-full"
            x-transition:enter-end="opacity-100 transform translate-y-0"
            x-transition:leave="transition ease-in duration-200"
            x-transition:leave-start="opacity-100 transform translate-y-0"
            x-transition:leave-end="opacity-0 transform -translate-y-full">
            <div class="notification-content">
                <div class="notification-icon">
                    <i class="fas fa-check"></i>
                </div>
                <span>Saved!</span>
            </div>
        </div>

        <!-- Error Notification -->
        <div class="notification-toast error" x-show="showErrorToast" x-cloak
            x-transition:enter="transition ease-out duration-300"
            x-transition:enter-start="opacity-0 transform -translate-y-full"
            x-transition:enter-end="opacity-100 transform translate-y-0"
            x-transition:leave="transition ease-in duration-200"
            x-transition:leave-start="opacity-100 transform translate-y-0"
            x-transition:leave-end="opacity-0 transform -translate-y-full">
            <div class="notification-content">
                <div class="notification-icon error">
                    <i class="fas fa-exclamation-triangle"></i>
                </div>
                <span x-text="errorMessage"></span>
            </div>
        </div>

        <!-- ============================================== -->
        <!-- CUSTOM MODALS (Fixed Overlay)                  -->
        <!-- ============================================== -->

        <!-- ============================================== -->
        <!-- CUSTOM MODALS (Fixed Overlay)                  -->
        <!-- ============================================== -->

        <!-- 1. General Confirmation Modal -->
        <div class="custom-modal-overlay" x-show="modal.open" x-transition.opacity :class="{ 'active': modal.open }"
            style="display: none !important;" x-init="$el.style.display = ''">
            <div class="custom-modal-card" @click.outside="closeModal()">
                <div class="custom-modal-header">
                    <h3 class="custom-modal-title" x-text="modal.title">Confirm</h3>
                    <button type="button" class="custom-modal-close" @click="closeModal()">&times;</button>
                </div>
                <div class="custom-modal-body">
                    <p class="mb-0" x-text="modal.message"></p>
                </div>
                <div class="custom-modal-footer">
                    <button type="button" class="btn btn-secondary" @click="closeModal()"
                        :disabled="isDeletingLane || isCompletingLane || isDeletingComment">Cancel</button>
                    <button type="button" class="btn" :class="'btn-' + modal.type" @click="confirmModalAction()"
                        :disabled="isDeletingLane || isCompletingLane || isDeletingComment">
                        <template x-if="!isDeletingLane && !isCompletingLane && !isDeletingComment">
                            <span x-text="modal.confirmText"></span>
                        </template>
                        <template x-if="isDeletingLane || isCompletingLane || isDeletingComment">
                            <span class="d-flex align-items-center gap-2">
                                <span class="spinner-border spinner-border-sm"></span>
                                Processing...
                            </span>
                        </template>
                    </button>
                </div>
            </div>
        </div>

        <!-- 2. Input Modal (Task/Swimlane) -->
        <div class="custom-modal-overlay" x-show="inputModal.open" x-transition.opacity
            :class="{ 'active': inputModal.open }" style="display: none !important;" x-init="$el.style.display = ''">
            <div class="custom-modal-card" @click.outside="closeInputModal()">

                <!-- Swimlane Header (Task mode only) - Top colored bar -->
                <template x-if="inputModal.mode === 'TASK' && inputModal.laneName">
                    <div class="px-4 py-3" style="background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);">
                        <div class="d-flex align-items-center gap-2">
                            <i class="fa-solid fa-layer-group text-white" style="font-size: 1.2rem;"></i>
                            <span class="text-white fw-bold" style="font-size: 1.25rem;"
                                x-text="inputModal.laneName"></span>
                        </div>
                    </div>
                </template>

                <!-- Modal Title Header (only for non-task mode, i.e., swimlane creation) -->
                <template x-if="inputModal.mode !== 'TASK'">
                    <div
                        class="px-4 py-2 border-bottom border-secondary d-flex justify-content-between align-items-center">
                        <span class="text-secondary fw-semibold text-uppercase"
                            style="font-size: 0.85rem; letter-spacing: 0.05em;" x-text="inputModal.title"></span>
                        <button type="button" class="btn-close btn-close-white" style="font-size: 0.7rem;"
                            @click="closeInputModal()"></button>
                    </div>
                </template>


                <div class="custom-modal-body">
                    <!-- Name Field (Always shown) -->
                    <div class="mb-3">
                        <label class="form-label text-light text-uppercase fw-bold mb-2"
                            style="font-size: 0.9rem; letter-spacing: 0.05em;">Name / Description</label>
                        <textarea class="form-control form-control-lg bg-dark text-white border-secondary"
                            placeholder="Enter name or description..." x-model="inputModal.value" x-ref="inputField"
                            rows="3" style="resize: vertical;"></textarea>
                    </div>

                    <!-- Task-specific fields -->
                    <template x-if="inputModal.mode === 'TASK'">
                        <div>
                            <!-- Status Dropdown -->
                            <div class="mb-3">
                                <label class="form-label text-light text-uppercase fw-bold mb-2"
                                    style="font-size: 0.9rem; letter-spacing: 0.05em;">Status</label>
                                <select class="form-select text-white" x-model="inputModal.status" style="background: linear-gradient(180deg, #2d3748 0%, #1a202c 100%); 
                                       border: 1px solid #4a5568; 
                                       border-radius: 8px; 
                                       padding: 12px 16px; 
                                       font-size: 1rem;
                                       cursor: pointer;">
                                    <template x-for="col in columns" :key="col">
                                        <option :value="col" x-text="col.replace('_', ' ')"></option>
                                    </template>
                                </select>
                            </div>

                            <!-- Tags Input with Chips -->
                            <div class="mb-3">
                                <label class="form-label text-light text-uppercase fw-bold mb-2"
                                    style="font-size: 0.9rem; letter-spacing: 0.05em;">Tags <span
                                        class="text-muted fw-normal">(press Enter to add)</span></label>

                                <!-- Tag Chips Display -->
                                <div class="d-flex flex-wrap gap-2 mb-2" x-show="inputModal.tags.length > 0">
                                    <template x-for="(tag, index) in inputModal.tags" :key="index">
                                        <span class="badge bg-primary d-flex align-items-center gap-1 py-2 px-3"
                                            style="font-size: 0.9rem;">
                                            <span x-text="tag"></span>
                                            <button type="button" class="btn-close btn-close-white ms-1"
                                                style="font-size: 0.6rem;" @click="removeTag(index)"
                                                aria-label="Remove tag"></button>
                                        </span>
                                    </template>
                                </div>

                                <!-- Tag Input Field -->
                                <input type="text" class="form-control bg-dark text-white border-secondary"
                                    placeholder="Type a tag and press Enter..." x-model="inputModal.tagInput"
                                    @keydown.enter.prevent="addTag()">
                            </div>
                        </div>
                    </template>
                </div>
                <div class="custom-modal-footer">
                    <button type="button" class="btn btn-secondary" @click="closeInputModal()"
                        :disabled="isSubmittingModal">Cancel</button>
                    <button type="button" class="btn btn-primary" @click="submitInputModal()"
                        :disabled="isSubmittingModal">
                        <template x-if="!isSubmittingModal">
                            <span>Save</span>
                        </template>
                        <template x-if="isSubmittingModal">
                            <span class="d-flex align-items-center gap-2">
                                <span class="spinner-border spinner-border-sm"></span>
                                Saving...
                            </span>
                        </template>
                    </button>
                </div>
            </div>
        </div>


    </main>

    <!-- Task Detail Pane (Desktop Only Sidebar) -->
    <aside class="task-detail-pane glass-panel" x-show="taskDetail.open && !isMobile"
        x-transition:enter="transition ease-out duration-300 transform" x-transition:enter-start="translate-x-full"
        x-transition:enter-end="translate-x-0" x-transition:leave="transition ease-in duration-200 transform"
        x-transition:leave-start="translate-x-0" x-transition:leave-end="translate-x-full"
        @click.outside="closeTaskDetail()" @keydown.window="handleDetailKeydown($event)" x-cloak>

        <template x-if="taskDetail.task">
            <div class="h-100 d-flex flex-column">
                <!-- Swimlane Header Bar -->
                <div class="px-4 py-3" style="background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);">
                    <div class="d-flex align-items-center gap-2">
                        <i class="fa-solid fa-layer-group text-white" style="font-size: 1rem;"></i>
                        <span class="text-white fw-bold" style="font-size: 1rem;"
                            x-text="taskDetail.task?.swimLane?.name || 'Unknown Swimlane'"></span>
                    </div>
                </div>

                <!-- Header -->
                <div
                    class="detail-header p-4 border-bottom border-secondary d-flex justify-content-between align-items-start">
                    <div class="d-flex flex-column gap-1">
                        <h3 class="h4 text-white mb-0" x-text="taskDetail.task?.name"></h3>
                    </div>
                    <button class="btn-close btn-close-white" @click="closeTaskDetail()"></button>
                </div>

                <div class="detail-body p-4 flex-grow-1 overflow-auto">
                    <!-- Tags -->
                    <div class="mb-4">
                        <label class="text-uppercase text-secondary fw-bold small mb-2 d-block">Tags</label>
                        <div class="d-flex flex-wrap gap-2">
                            <template x-for="tag in getTags(taskDetail.task?.tags)" :key="tag">
                                <span class="tag-capsule active" x-text="tag"></span>
                            </template>
                            <template x-if="getTags(taskDetail.task?.tags).length === 0">
                                <span class="text-secondary small fst-italic">No tags</span>
                            </template>
                        </div>
                    </div>

                    <!-- Status -->
                    <div class="mb-4">
                        <label class="text-uppercase text-secondary fw-bold small mb-2 d-block">Status</label>
                        <span class="badge"
                            :class="taskDetail.task?.status ? 'status-badge-' + taskDetail.task.status.toLowerCase() : ''"
                            x-text="taskDetail.task?.status ? taskDetail.task.status.replace('_', ' ') : ''">
                        </span>
                    </div>


                    <!-- Comments -->
                    <div class="comments-section">
                        <label class="text-uppercase text-secondary fw-bold small mb-3 d-block">Comments</label>

                        <div class="comments-list mb-4">
                            <template x-for="(comment, index) in getTaskComments(taskDetail.task)"
                                :key="comment.id || index">
                                <div class="comment-item mb-3 p-3 rounded bg-dark border border-secondary"
                                    :class="{'border-primary': taskDetail.editingCommentId === comment.id, 'comment-selected': isCommentSelected(index)}">
                                    <div class="d-flex justify-content-between mb-1">
                                        <div class="d-flex align-items-center gap-2">
                                            <span class="fw-bold text-primary small">User</span>
                                            <span class="text-muted smaller"
                                                x-text="comment.createdAt ? new Date(comment.createdAt).toLocaleString() : new Date().toLocaleString()"></span>
                                        </div>
                                        <!-- Actions -->
                                        <div class="comment-actions d-flex gap-2"
                                            x-show="taskDetail.editingCommentId !== comment.id">
                                            <button class="btn btn-link btn-sm p-0 text-secondary hover-opacity-100"
                                                @click="startEditComment(comment)" title="Edit">
                                                <i class="fa-solid fa-pen-to-square"></i>
                                            </button>
                                            <button class="btn btn-link btn-sm p-0 text-danger hover-opacity-100"
                                                @click="deleteComment(comment.id)" title="Delete">
                                                <i class="fa-solid fa-trash"></i>
                                            </button>
                                        </div>
                                    </div>

                                    <!-- Static Text -->
                                    <template x-if="taskDetail.editingCommentId !== comment.id">
                                        <p class="mb-0 text-white-50" x-text="comment.text || comment"
                                            style="white-space: pre-wrap;"></p>
                                    </template>

                                    <!-- Inline Edit -->
                                    <template x-if="taskDetail.editingCommentId === comment.id">
                                        <div class="mt-2">
                                            <textarea
                                                class="form-control form-control-sm bg-dark text-white border-secondary mb-2"
                                                x-model="taskDetail.editingCommentText" rows="2" autofocus></textarea>
                                            <div class="d-flex justify-content-end gap-2">
                                                <button class="btn btn-sm btn-outline-secondary"
                                                    @click="cancelEditComment()"
                                                    :disabled="taskDetail.isLoading">Cancel</button>
                                                <button class="btn btn-sm btn-primary" @click="updateComment()"
                                                    :disabled="taskDetail.isLoading || !taskDetail.editingCommentText.trim()">
                                                    <span x-show="!taskDetail.isLoading">Save</span>
                                                    <span class="spinner-border spinner-border-sm"
                                                        x-show="taskDetail.isLoading"></span>
                                                </button>
                                            </div>
                                        </div>
                                    </template>
                                </div>
                            </template>
                            <template x-if="getTaskComments(taskDetail.task).length === 0">
                                <div class="text-center py-4">
                                    <i class="fa-regular fa-comments fa-2x mb-2 d-block text-secondary opacity-50"></i>
                                    <span class="text-secondary fst-italic">No comments yet</span>
                                </div>

                            </template>
                        </div>
                    </div>
                </div>

                <!-- Footer (Add Comment) -->
                <div class="detail-footer p-4 border-top border-secondary">
                    <div class="input-group gap-2">
                        <textarea class="form-control bg-dark text-white border-secondary rounded"
                            placeholder="Add a comment..." x-model="taskDetail.newComment" rows="2"
                            @keydown.enter.ctrl="addComment()" :disabled="taskDetail.isLoading"></textarea>
                        <button class="btn btn-primary rounded" @click="addComment()"
                            :disabled="!taskDetail.newComment.trim() || taskDetail.isLoading">
                            <i class="fa-solid fa-paper-plane" x-show="!taskDetail.isLoading"></i>
                            <span class="spinner-border spinner-border-sm" x-show="taskDetail.isLoading"></span>
                        </button>
                    </div>
                    <div class="mt-3 pt-2 text-secondary smaller">
                        <kbd>Alt</kbd>+<kbd>Enter</kbd> to post &bull; <kbd>↑</kbd><kbd>↓</kbd> to navigate &bull;
                        <kbd>Esc</kbd> to close
                    </div>
                </div>
            </div>
        </template>
    </aside>

    <!-- JS Dependencies -->
    <script defer src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script defer src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>

    <!-- Main Application - Minified ES Module -->
    <script type="module" src="js/app.min.js"></script>

    <!-- Bootstrap Bundle JS for dropdown functionality -->
    <script defer src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>


    <script>
        // ============================================
        // SESSION MANAGEMENT
        // ============================================

        // Log session-based login
        // Note: JSESSIONID is HttpOnly (can't be read by JavaScript for security)
        // If user is on this page, they are authenticated
        (function logSessionLogin() {
            console.log('[Session] User authenticated - page loaded successfully');
            console.log('[Session] Login timestamp:', new Date().toISOString());
        })();

        // 1. Prevent back button navigation to login page
        if (window.history && window.history.pushState) {
            window.history.pushState(null, '', window.location.href);
            window.onpopstate = function () {
                window.history.pushState(null, '', window.location.href);
            };
        }

        // 2. Auto-logout at end of calendar day (midnight)
        (function setupEODLogout() {
            const now = new Date();
            const midnight = new Date();
            midnight.setHours(23, 59, 59, 999);

            const msUntilMidnight = midnight.getTime() - now.getTime();

            console.log('[Session] Auto-logout scheduled at midnight. Time remaining:',
                Math.round(msUntilMidnight / 60000), 'minutes');

            // Store login date in sessionStorage
            const loginDate = sessionStorage.getItem('loginDate');
            const today = now.toDateString();

            if (loginDate && loginDate !== today) {
                // It's a new day since login, log out immediately
                console.log('[Session] New calendar day detected. Logging out...');
                window.location.href = '/logout';
                return;
            }

            // Store today's date
            sessionStorage.setItem('loginDate', today);

            // Schedule logout at midnight
            setTimeout(function () {
                console.log('[Session] End of day reached. Logging out...');
                sessionStorage.removeItem('loginDate');
                window.location.href = '/logout';
            }, msUntilMidnight);
        })();
    </script>
</body>

</html>